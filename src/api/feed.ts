
import { Readable } from "https://deno.land/std@0.177.0/node/stream.ts";

import { PoolExecutor } from "../utils/pool.ts";


export interface Feed<T> {
  isUpToDate(date: Date): Promise<boolean>;
  get(): Promise<T>;
}
export type RawCPE = {
  cpe23Uri: string;
  cpe_name: { cpe23Uri: string }[];

  versionStartExcluding?: string;
  versionStartIncluding?: string;
  versionEndExcluding?: string;
  versionEndIncluding?: string;
};

export type CPEFeedType = {
  matches: RawCPE[];
};

async function myReadbleStream(blob: Blob, pool:PoolExecutor) {
  const buffSize = 1024 * 10;
  let start = 0;
  let end = buffSize;
  const data: ArrayBuffer[] = [];
  while (true) {
    const slice = blob.slice(start, end);
    const buf = await slice.arrayBuffer();
    if (slice.size === 0) {
      break;
    }
    data.push(new Uint8Array(buf));
    start += buffSize;
    end += buffSize;
  }

  return new Readable({
    read() {
      if (data.length === 0) {
        this.push(null);
        console.log('all data is pushed');
      } else {

        if (pool.getWaiting() > 3) { // kinda arbitrary
          console.log('slow');
          setTimeout(() => this.push(data.shift()), 1000);
        } else {
          if (data.length % 100) {
            setTimeout(() => this.push(data.shift()), 100);
          } else {
            this.push(data.shift())
          }
        }
      }
    }
  })
}


export class CPEFeed {
  url = "https://nvd.nist.gov/feeds/json/cpematch/1.0/nvdcpematch-1.0.json.gz";
  getUpdateDate(r: Response): Date | undefined {
    const h = r.headers.get("last-modified");
    if (h) {
      return new Date(h);
    }
    return undefined;
  }

  async isUpToDate(date: Date) {
    const resp = await fetch(this.url, {
      method: "HEAD",
    });
    const currentLastUpdate = this.getUpdateDate(resp);
    console.log(resp.status);
    if (currentLastUpdate!.getTime() > date.getTime()) {
      return false;
    }
    return true;
  }

  async get(pool: PoolExecutor) {
    const response = await fetch(this.url);
    const blob = await response.blob();
    console.log('file downloaded');
    return myReadbleStream(blob, pool);
  }
}
