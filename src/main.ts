import { BulkWriteResult, Collection, MongoClient } from "npm:mongodb@5.0.1";
import { client } from "./conf.ts";

import { DataIngester, getMissingDataChunks, populateCves } from "./index.ts";
import {
  DebugPersistorFactory,
  MongoPersistorFactory,
} from "./utils/persistor.ts";

// const defaultStartDate = new Date("2023-02-01T01:00:00");
// const defaultEndDate = new Date("2023-02-14T13:00:00");

// for dev purposes while waiting to differential update
// await populateDB({
//   startDate: defaultStartDate,
//   endDate: defaultEndDate,
// });

// console.log(await getMissingDataChunks());

let isDebug = true;

function getPersistorFactory() {
  if (isDebug) {
    return new DebugPersistorFactory();
  } else {
    // TODO: stub for now
    // @ts-ignore
    return new MongoPersistorFactory(null);
  }
}

export async function ensureDataIsUpToDate() {
  // read conf
  // create ingester
  // update all
  const ingester = new DataIngester(getPersistorFactory(), "newcvedb");
  await ingester.populateCPE();
}

await ensureDataIsUpToDate();
