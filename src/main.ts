import { client } from "./conf.ts";

import { DataIngester } from "./index.ts";
import {
  DebugPersistorFactory,
  MongoPersistorFactory,
} from "./utils/persistor.ts";

function getPersistorFactory(isDebug: boolean) {
  if (isDebug) {
    return new DebugPersistorFactory();
  } else {
    return new MongoPersistorFactory(client);
  }
}

export async function ensureDataIsUpToDate() {
  // read conf
  const dbName = "newcvedb";
  const debug = Boolean(Deno.env.get("DEBUG")) || false;
  const persistor = getPersistorFactory(debug);
  const ingester = new DataIngester(persistor, dbName);
  await ingester.populateCPE();
  await ingester.populateCVE();
}

await ensureDataIsUpToDate();
