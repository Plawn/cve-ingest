import { CPEIngester } from "./ingesters/cpe/cpe.ts";
import { CPE } from "./ingesters/cpe/type.ts";
import { CVEIngester } from "./ingesters/cve/cve.ts";
import { CVEInfos, UpdateProps } from "./ingesters/cve/type.ts";
import { PersistorFactory } from "./utils/persistor.ts";
import { ExportedCVESearch } from "./utils/types.ts";

export const cpeCollectionName = "cpes";
export const cveCollectionName = "cves";
export const cveInfosCollectionName = "infos";

export class DataIngester<DatabaseName extends string> {
  databaseName: DatabaseName;
  factory: PersistorFactory;
  opened = true;

  constructor(client: PersistorFactory, databaseName: DatabaseName) {
    this.factory = client;
    this.databaseName = databaseName;
  }

  /**
   * Gets all the cpe matches from NVD and puts them in the mongo db
   */
  async populateCPE() {
    const persistor = await this.factory.make(
      this.databaseName,
      cpeCollectionName,
      (cpe: CPE) => ({ id: cpe.id }),
    );
    await persistor.open();
    const cpeHandler = new CPEIngester(persistor);
    await cpeHandler.update();
    await persistor.close();
  }


  async populateCVE(props?: UpdateProps) {
    const cpePersistor = await this.factory.make(
      this.databaseName,
      cpeCollectionName,
      (cpe: CPE) => ({ id: cpe.id }),
    );
    await cpePersistor.open();

    const cvePersistor = await this.factory.make(
      this.databaseName,
      cveCollectionName,
      (cve: ExportedCVESearch) => ({ id: cve.id }),
    );
    await cpePersistor.open();
    const infoPersistor = await this.factory.make(
      this.databaseName,
      "infos",
      (infos: CVEInfos) => ({ id: infos.id }),
    );
    await cpePersistor.open();
    const cveHandler = new CVEIngester(cvePersistor, cpePersistor, infoPersistor);
    await cveHandler.populateCves(props);
    cvePersistor.close(); // closing the client so no need to close others but no clean
    // cpePersistor.close();
    // infoPersistor.close();
  }
}
