import { BulkWriteResult, Collection, MongoClient } from "npm:mongodb@5.0.1";
import { getMissingDataChunks, populateCves } from "./cve.ts";
import { CPE, CPEIngester } from "./cpe.ts";
import { MongoPersistor, PersistorFactory } from "./utils/persistor.ts";

export { getMissingDataChunks, populateCves };

export const cpeCollectionName = "cpes";

export class DataIngester<DatabaseName extends string> {
  databaseName: DatabaseName;
  factory: PersistorFactory;

  constructor(client: PersistorFactory, databaseName: DatabaseName) {
    this.factory = client;
    this.databaseName = databaseName;
  }

  async populateCPE() {
    const persistor = await this.factory.make(
      this.databaseName,
      cpeCollectionName,
      (cpe: CPE) => ({ id: cpe.id }),
    );
    await persistor.open();
    const cpeHandler = new CPEIngester(persistor);
    await cpeHandler.update();
    await persistor.close();
  }
}
