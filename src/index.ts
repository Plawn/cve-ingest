import { CPEIngester } from "./ingesters/cpe/cpe.ts";
import { CPE } from "./ingesters/cpe/type.ts";
import { PersistorFactory } from "./utils/persistor.ts";

export const cpeCollectionName = "cpes";
export const cveCollectionName = "cpes";
export const cveInfosCollectionName = "infos";

export class DataIngester<DatabaseName extends string> {
  databaseName: DatabaseName;
  factory: PersistorFactory;

  constructor(client: PersistorFactory, databaseName: DatabaseName) {
    this.factory = client;
    this.databaseName = databaseName;
  }

  /**
   * Gets all the cpe matches from NVD and puts them in the mongo db
   */
  async populateCPE() {
    const persistor = await this.factory.make(
      this.databaseName,
      cpeCollectionName,
      (cpe: CPE) => ({ id: cpe.id }),
    );
    await persistor.open();
    const cpeHandler = new CPEIngester(persistor);
    await cpeHandler.update();
    await persistor.close();
  }
}
