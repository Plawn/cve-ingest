import { CPEIngester } from "./ingesters/cpe/cpe.ts";
import { CPE } from "./ingesters/cpe/type.ts";
import { CVEIngester } from "./ingesters/cve/cve.ts";
import { UpdateProps } from "./ingesters/cve/type.ts";
import { PersistorFactory } from "./utils/persistor.ts";
import { ExportedCVESearch, Update } from "./utils/types.ts";


// TODO : To be removed
export const infosTable = "INFOS";
export const cpeFeed = "CPE";
export const cveFeed = "CVE";


export class DataIngester<DatabaseName extends string> {
  databaseName: DatabaseName;
  factory: PersistorFactory;
  opened = true;

  constructor(client: PersistorFactory, databaseName: DatabaseName) {
    this.factory = client;
    this.databaseName = databaseName;
  }

  protected getCPEPersistor = async () => {
    const persistor = await this.factory.make(
      this.databaseName,
      cpeFeed,
      (cpe: CPE) => ({ id: cpe.id }),
    );
    return persistor;
  };

  protected getCVEPersistor = async () => {
    const cvePersistor = await this.factory.make(
      this.databaseName,
      cveFeed,
      (cve: ExportedCVESearch) => ({ id: cve.id }),
    );
    return cvePersistor;
  };

  protected getUpdatePersistor = async () => {
    const infoPersistor = await this.factory.make(
      this.databaseName,
      infosTable,
      (update: Update) => ({ id: update.id })
    );
    return infoPersistor;
  };

  /**
   * Gets all the cpe matches from NVD and puts them in the mongo db
   */
  async populateCPE() {
    const persistor = await this.getCPEPersistor();
    await persistor.open();
    const updatePersistor = await this.getUpdatePersistor();
    const cpeHandler = new CPEIngester(persistor, updatePersistor);
    await cpeHandler.populateCpes()
    //await cpeHandler.update();
    await persistor.close();
  }

  async populateCVE(props?: UpdateProps) {
    const cpePersistor = await this.getCPEPersistor();
    await cpePersistor.open();

    const cvePersistor = await this.getCVEPersistor();
    await cpePersistor.open();

    const updatePersistor = await this.getUpdatePersistor();
    await cpePersistor.open();

    const cveHandler = new CVEIngester(
      cvePersistor,
      cpePersistor,
      updatePersistor,
    );
    await cveHandler.populateCves(props);

    cvePersistor.close(); // closing the client so no need to close others but no clean
    // cpePersistor.close();
    // infoPersistor.close();
  }
}
